<html lang=”en”>

<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- Name of the app -->
	<title>Camera App</title>
	<!-- Link to main style sheet -->
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<main class="main-body">
		<h1>DEMO 3.1.3</h1>
		<canvas id="myCanvas" width="300" height="300" style="border:1px solid #d3d3d3;">
			Your browser does not support the HTML5 canvas tag.</canvas>
		<div>
			<a id="download" href="">Download</a>
		</div>
		<div class="example-block">
			<input type="file" name="image" accept="image/*,video/*,capture=camera" id="image-camera"
				onchange="UploadImage(files)">
		</div>
		<img id='img-test' />
		<div id="note"></div>
		<div id="canvas-test"></div>
	</main>


	<!-- Reference to your JavaScript file -->
	<script>
		var c = document.getElementById("myCanvas");
		c.onclick = () => {
			document.getElementById('image-camera').click()
		}
		var ctx = c.getContext("2d");
		var img = new Image()
		img.src = './images/fameimage.png'
		onload = () => {
			ctx.drawImage(img, 0, 0, c.width, c.height);
		}
		var i;
		var video

		//random name download
		makeid = (length) => {
			var result = '';
			var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			var charactersLength = characters.length;
			for (var i = 0; i < length; i++) {
				result += characters.charAt(Math.floor(Math.random() * charactersLength));
			}
			return result;
		}
		//random name download

		UploadImage = (value) => {
			var note = "";
			if (video) {
				video.pause()
			}
			if (i) {
				clearInterval(i);
			}
			ctx.clearRect(0, 0, c.width, c.height);
			ctx.drawImage(img, 0, 0, c.width, c.height);
			var source = value[0]
			var type = source.type.split('/')[0]
			note += 'Type: ' + type + '\n'
			var reader = new FileReader();
			if (source) {
				reader.readAsDataURL(source);
			}
			document.getElementById('note').innerText = note
			reader.onload = () => {
				if (type === 'image') {
					var img2 = new Image();
					img2.src = reader.result
					img2.onload = () => {
						var rwh = img2.width / img2.height
						var newWidth = c.width
						var newHeight = newWidth / rwh
						if (rwh > 1) {
							newHeight = c.height
							newWidth = newHeight * rwh
						}
						var xOffset = rwh > 1 ? ((c.width - newWidth) / 2) : 0;
						var yOffset = rwh <= 1 ? ((c.height - newHeight) / 2) : 0;
						ctx.drawImage(img2, xOffset, yOffset, newWidth, newHeight);
						ctx.drawImage(img, 0, 0, c.width, c.height);
						var download = document.getElementById('download');
						var dataURL = c.toDataURL('video/mp4', 1.0);
						download.href = dataURL
						download.download = makeid(10) + '.mp4'
					}
				}
				else if (type === 'video') {
					video = document.createElement('VIDEO')
					video.muted = true
					video.src = reader.result
					video.play()
					const chunks = [];
					const stream = c.captureStream();
					const rec = new MediaRecorder(stream);
					rec.ondataavailable = e => chunks.push(e.data);
					rec.start();
					console.log(rec)
					video.onloadeddata = () => {
						console.log('start')
						var rwh = video.videoWidth / video.videoHeight
						var newWidth = c.width
						var newHeight = newWidth / rwh
						if (rwh > 1) {
							newHeight = c.height
							newWidth = newHeight * rwh
						}
						var xOffset = rwh > 1 ? ((c.width - newWidth) / 2) : 0;
						var yOffset = rwh <= 1 ? ((c.height - newHeight) / 2) : 0;
						i = setInterval(() => {
							ctx.drawImage(video, xOffset, yOffset, newWidth, newHeight);
							ctx.drawImage(img, 0, 0, c.width, c.height)
						}, 20);
					}
					video.onended = () => {
						console.log('end')
						rec.onstop = e => {
							console.log()
							exportVid(new Blob(chunks, { type: 'video/mp4' }))
						};
						rec.stop()
					}
				}
				else {
					alert('File not supported')
				}
			}
		}

		exportVid = (blob) => {
			const vid = document.createElement('video');
			vid.src = URL.createObjectURL(blob);
			console.log(vid.src)
			// vid.controls = true;
			document.body.appendChild(vid);
			vid.play()
			const a = document.createElement('a');
			a.download = 'myvid.mp4';
			a.href = vid.src;
			a.textContent = 'download the video';
			console.log(a)
			a.click()
		}
	</script>
</body>

</html>